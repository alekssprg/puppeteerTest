# TestUI

== Порядок разворачивания системы:
. Скачать исходники проекта с GitLab
. Установить Node JS версии 12 и выше (https://nodejs.org/)
. Запустить комадную строку и перейти в папку проекта
. Выполнить `npm install`
. Установить Visual Studio Code (разработку удобнее всего вести в ней https://code.visualstudio.com/)
. Открыть в Visual Studio Code созданную под проект папку
. Выполнить запуск проекта
.. Запуск можно выполнить через Visual Studio Code (Run). *Отладка выполняется именно этим способом.*
.. А также из командной строки `npm test`


== Набор библиотек, используемых в проекте:

. `Puppeteer JS` - библиотека, реализующая Chrome Dev Tools протокол для работы браузером (поддерживают Chromium, Chrome, Firefox)
. `Mocha` - библиотека для создания и запуска тестов
. `Chai` (Test Assertion Library) - библиотека утверждений
. `node-cmd` (Run Command Line Command in Node JS) - запуск window команд из node js скрипта
. `opn` (open the report of testing automatically to browser) - автоматическое открывание результатов тестов в браузере
. `Express JS` (Web server to serve report)	- минималистичный web-сервер
. `Mochawesome` (for Report generation)	- генератор отчетов для mocha
. `chai-http` - отправка запросов к web-сервисам.
. `lodash` - библиотека, используется для сохранения глобальных объектов
. `soap` - библиотека для создания SOAP клиентов для тестирования сервисов
. `mssql` - подключение к БД MS SQL и выполнение команд

=== Для создания аналогичного проекта с нуля можно почитать пример:
https://medium.com/@tariqul.islam.rony/automated-ui-ux-testing-with-puppeteer-mocha-and-chai-800cfb028ab9

=== Настройки запуска тестов
При запуске тестов из Visual Studio Code настройки храняться в файле launch.json:

* `node` - программа, которая будет выполнять скрипты, и к которой нужно присоединится для отладки
* `program` - запускаемая программа "${workspaceFolder}/node_modules/mocha/bin/_mocha" - путь к Mocha - собираем все тесты.
* `args` - аргументы. Если указать ``"--grep", "RecipeService"``
то будут запущены только тесты, содержащие в описании "RecipeService".


== Правила написания тестов
. Для написания тестов интерфейса используется Puppeteer. Документацию по доступным методам Puppeteer можно найти здесь (https://github.com/puppeteer/puppeteer) и здесь (https://devdocs.io/puppeteer/) и здесь (https://pptr.dev/)
. При написании тестов нужно помнить, что Puppeteer работает именно с DOM элементами страницы и ему нужны доп. инструменты для получения именно объекта DOM.
. Эти инструменты предоставляет `window.SpargoJs.Test` - скрипты в нашем ПО.
. Их можно расширять и улучшать. Скрипты загружаются при открытии любого АРМ-а.
. Обращение к скриптам `window.SpargoJs.Test` выполняется через функции `page.evaluate` и `page.evaluateHandle`, которые выполняют код на стороне браузера.
. Все файлы с тестами должны оканчиваться расширение *.spec.js
. На текущий момент создан базовый функционал для работы с журналами и документами. Его нужно использовать и расширять.
. Правила написания тестов можно посмотреть на сайте Mocha (https://mochajs.org/)
. Правила написания утверждений можно посмотреть на сайте Chai (https://www.chaijs.com/)
. У Moche есть служебные секции для подготовки данных или настройки тестов (или для очистки данных). Секции создаются внтури decribe:
* `before()` - выполняется перед всеми тестами
* `after()` - выполняется после всех тестов
* `beforeEach()` - выполняется перед каждым тестом
* `afterEach()` - выполняется после каждого теста
. Если нужно явно указать завершение теста, то нужно использовать конструкцию
`it('имя теста',(done) => {
        //...код теста
        done();
    });`
. Файл `bootstrap.js` является стартовым для всех тестов (указан при запуске тестов). В нем:
* запускается браузер через puppeteer
* задается режим работы браузера (headless: false или true)
* параметр `slowMo: 100` отвечает за замедление имитации действий пользователя
* в конце прогона тестов формируется отчет в папке: mochawesome-report\
* Если нужно - его можно открывать, раскомментировав последний строки в файле с запуском веб-сервера.

== Требования к тестам
. Все тесты должны иметь четкое уникальное название
. Тесты должны иметь возможность выполнятся независимо друг от друга и в любом порядке
. В тестах, за редким исключением, не должно использовать ожидание (sleep(1000), waitFor(1000)).
Все ожидания нужно делать по условию (waitForFunction).
. Код теста должен быть линейным без циклов и условий (циклы могут быть только по тестовым данным).
. Все тесты пока лежат в папке test. В дальнейшем их можно разбить на разные папки по функционалу, который они тестируют.
. Вспомогательные классы также лежат здесь.
. Созданные в результата прогона теста данные в БД должны быть удалены.
. Тесты должны быть короткие (не более 20 строк)
. В тестах не должны быть вывода в консоль или другой отладочной информации
. Дублирование кода нужно избегать
. Тесты должны работать стабильно
. В идеале тесты должны содержать assert-ы. Пока выполняется просто проход по сценарию.
. Тесты интерфейса должны покрывать основной критичный функционал. Не нужно писать их слишком много.

== Данные для тестов
. Храняться в папке testData
. `authorizateData.json` - данные для авторизации
. `baseSettings.json` - настройки подключения к БД и АРМ-ом
. `documentDataSettings.json` - метаданные о документах
. `journalDataSettings.json` - метаданные о журналах (справочниках)

== Задачи следующего этапа
. Настроить запуск тестов при сборке проекта.
. Сделать копию боевой БД с заготовленными данными
либо сформировать скрипты для разворачивания базы для тестов.